apiVersion: v1
kind: ConfigMap
metadata:
  name: valkey-config
  namespace: {{ .Values.namespace }}
data:
  valkey.conf: |
    # ValKey Server Configuration
    port 6379
    bind 0.0.0.0
    loglevel {{ .Values.logLevel }}

    # Memory Management
    maxmemory {{ .Values.memory.maxMemory }}
    maxmemory-policy {{ .Values.memory.maxMemoryPolicy }}

    # Persistence - RDB
    {{- if .Values.persistence.rdb.enabled }}
    save {{ .Values.persistence.rdb.interval }} {{ .Values.persistence.rdb.minChanges }}
    rdbcompression yes
    rdbchecksum yes
    dbfilename dump.rdb
    dir /data
    {{- end }}

    # Persistence - AOF
    {{- if .Values.persistence.aof.enabled }}
    appendonly yes
    appendfilename "appendonly.aof"
    appendfsync {{ .Values.persistence.aof.fsync }}
    {{- end }}

    # Replication
    {{- if eq .Values.architecture "replication" }}
    replica-read-only yes
    replica-serve-stale-data yes
    {{- end }}

    # Security
    {{- if .Values.auth.enabled }}
    requirepass $(VALKEY_PASSWORD)
    {{- end }}

    # Slow Log
    slowlog-log-slower-than 10000
    slowlog-max-len 128

    # Client Output Buffer Limit
    client-output-buffer-limit normal 0 0 0
    client-output-buffer-limit replica 256mb 64mb 60
    client-output-buffer-limit pubsub 32mb 8mb 60

{{- if .Values.kong.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "supabase.fullname" . }}-kong-config
  labels:
    {{- include "supabase.kong.labels" . | nindent 4 }}
data:
  kong.yml: |
    _format_version: "2.1"
    _transform: true

    services:
      - name: auth-v1-open
        url: http://{{ include "supabase.fullname" . }}-auth:9999/verify
        routes:
          - name: auth-v1-open
            strip_path: true
            paths:
              - /auth/v1/verify
        plugins:
          - name: cors

      - name: auth-v1-open-callback
        url: http://{{ include "supabase.fullname" . }}-auth:9999/callback
        routes:
          - name: auth-v1-open-callback
            strip_path: true
            paths:
              - /auth/v1/callback
        plugins:
          - name: cors

      - name: auth-v1-open-authorize
        url: http://{{ include "supabase.fullname" . }}-auth:9999/authorize
        routes:
          - name: auth-v1-open-authorize
            strip_path: true
            paths:
              - /auth/v1/authorize
        plugins:
          - name: cors

      - name: auth-v1
        _comment: "GoTrue: /auth/v1/* -> http://auth:9999/*"
        url: http://{{ include "supabase.fullname" . }}-auth:9999/
        routes:
          - name: auth-v1-all
            strip_path: true
            paths:
              - /auth/v1/
        plugins:
          - name: cors

      - name: rest-v1
        _comment: "PostgREST: /rest/v1/* -> http://rest:3000/*"
        url: http://{{ include "supabase.fullname" . }}-rest:3000/
        routes:
          - name: rest-v1-all
            strip_path: true
            paths:
              - /rest/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: false

      - name: graphql-v1
        _comment: "PostgREST: /graphql/v1/* -> http://rest:3000/rpc/graphql"
        url: http://{{ include "supabase.fullname" . }}-rest:3000/rpc/graphql
        routes:
          - name: graphql-v1-all
            strip_path: true
            paths:
              - /graphql/v1
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: false

      - name: realtime-v1
        _comment: "Realtime: /realtime/v1/* -> ws://realtime:4000/socket/*"
        url: http://{{ include "supabase.fullname" . }}-realtime:4000/socket/
        routes:
          - name: realtime-v1-all
            strip_path: true
            paths:
              - /realtime/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: false

      - name: storage-v1
        _comment: "Storage: /storage/v1/* -> http://storage:5000/*"
        url: http://{{ include "supabase.fullname" . }}-storage:5000/
        routes:
          - name: storage-v1-all
            strip_path: true
            paths:
              - /storage/v1/
        plugins:
          - name: cors

      - name: meta
        _comment: "pg-meta: /pg/* -> http://meta:8080/*"
        url: http://{{ include "supabase.fullname" . }}-meta:8080/
        routes:
          - name: meta-all
            strip_path: true
            paths:
              - /pg/
        plugins:
          - name: key-auth
            config:
              hide_credentials: false
          - name: cors

      - name: functions-v1
        _comment: "Edge Functions: /functions/v1/* -> http://edge-runtime:8081/*"
        url: http://{{ include "supabase.fullname" . }}-edge-runtime:8081/
        routes:
          - name: functions-v1-all
            strip_path: true
            paths:
              - /functions/v1/
        plugins:
          - name: cors

    consumers:
      - username: anon
        keyauth_credentials:
          - key: {{ .Values.jwt.anonKey | default "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0" }}
      - username: service_role
        keyauth_credentials:
          - key: {{ .Values.jwt.serviceRoleKey | default "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU" }}

    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - HEAD
            - PUT
            - PATCH
            - POST
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Auth-Token
            - X-Client-Info
            - apikey
            - Authorization
          exposed_headers:
            - X-Resource-Count
          credentials: true
          max_age: 3600
{{- end }}

{{- if .Values.initJob.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "supabase.fullname" . }}-init
  labels:
    {{- include "supabase.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  template:
    metadata:
      name: {{ include "supabase.fullname" . }}-init
      labels:
        {{- include "supabase.labels" . | nindent 8 }}
    spec:
      restartPolicy: Never
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: init
        image: "{{ .Values.initJob.image.repository }}:{{ .Values.initJob.image.tag }}"
        imagePullPolicy: {{ .Values.initJob.image.pullPolicy }}
        env:
        - name: PGHOST
          value: {{ .Values.postgresql.host | quote }}
        - name: PGPORT
          value: {{ .Values.postgresql.port | quote }}
        - name: PGDATABASE
          value: {{ .Values.postgresql.database | quote }}
        - name: PGUSER
          value: {{ .Values.postgresql.user | quote }}
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "supabase.postgresql.secretName" . }}
              key: {{ .Values.postgresql.existingSecretPasswordKey }}
        command:
        - sh
        - -c
        - |
          set -e
          echo "Waiting for PostgreSQL to be ready..."
          until pg_isready -h $PGHOST -p $PGPORT -U $PGUSER; do
            echo "PostgreSQL is unavailable - sleeping"
            sleep 2
          done
          
          echo "PostgreSQL is ready! Initializing Supabase database..."
          
          # Create database if it doesn't exist
          psql -h $PGHOST -p $PGPORT -U $PGUSER -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = '${PGDATABASE}'" | grep -q 1 || \
            psql -h $PGHOST -p $PGPORT -U $PGUSER -d postgres -c "CREATE DATABASE ${PGDATABASE};"
          
          # Connect to the supabase database and create extensions
          psql -h $PGHOST -p $PGPORT -U $PGUSER -d $PGDATABASE <<-EOSQL
            -- Enable required extensions
            CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
            CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";
            {{- range .Values.initJob.extensions }}
            CREATE EXTENSION IF NOT EXISTS "{{ . }}";
            {{- end }}
            
            -- Create schemas
            {{- range .Values.initJob.schemas }}
            CREATE SCHEMA IF NOT EXISTS {{ . }};
            {{- end }}
            
            -- Grant necessary permissions
            GRANT USAGE ON SCHEMA public TO postgres, anon, authenticated, service_role;
            GRANT ALL ON ALL TABLES IN SCHEMA public TO postgres, anon, authenticated, service_role;
            GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO postgres, anon, authenticated, service_role;
            GRANT ALL ON ALL ROUTINES IN SCHEMA public TO postgres, anon, authenticated, service_role;
            
            -- Create roles if they don't exist
            DO \$\$
            BEGIN
              IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'anon') THEN
                CREATE ROLE anon NOLOGIN;
              END IF;
              IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'authenticated') THEN
                CREATE ROLE authenticated NOLOGIN;
              END IF;
              IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'service_role') THEN
                CREATE ROLE service_role NOLOGIN BYPASSRLS;
              END IF;
            END
            \$\$;
            
            -- Grant access to schemas
            {{- range .Values.initJob.schemas }}
            GRANT USAGE ON SCHEMA {{ . }} TO postgres, anon, authenticated, service_role;
            GRANT ALL ON ALL TABLES IN SCHEMA {{ . }} TO postgres, anon, authenticated, service_role;
            GRANT ALL ON ALL SEQUENCES IN SCHEMA {{ . }} TO postgres, anon, authenticated, service_role;
            GRANT ALL ON ALL ROUTINES IN SCHEMA {{ . }} TO postgres, anon, authenticated, service_role;
            {{- end }}
            
            -- Set default privileges
            ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT ALL ON TABLES TO postgres, anon, authenticated, service_role;
            ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT ALL ON SEQUENCES TO postgres, anon, authenticated, service_role;
            ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT ALL ON ROUTINES TO postgres, anon, authenticated, service_role;
          EOSQL
          
          echo "Supabase database initialization completed successfully!"
        resources:
          {{- toYaml .Values.initJob.resources | nindent 10 }}
{{- end }}

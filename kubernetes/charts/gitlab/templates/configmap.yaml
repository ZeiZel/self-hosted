apiVersion: v1
kind: ConfigMap
metadata:
  name: gitlab-config
  namespace: {{ .Values.namespace }}
data:
  gitlab.rb: |
    # External URL
    external_url "{{ .Values.gitlab.config.external_url }}"
    time_zone "{{ .Values.gitlab.config.time_zone }}"

    # PostgreSQL
    postgresql['enable'] = false
    gitlab_rails['db_adapter'] = 'postgresql'
    gitlab_rails['db_encoding'] = 'utf8'
    gitlab_rails['db_host'] = ENV['POSTGRES_HOST']
    gitlab_rails['db_port'] = ENV['POSTGRES_PORT']
    gitlab_rails['db_username'] = ENV['POSTGRES_USER']
    gitlab_rails['db_password'] = ENV['POSTGRES_PASSWORD']
    gitlab_rails['db_database'] = ENV['POSTGRES_DB']

    # Redis
    redis['enable'] = false
    gitlab_rails['redis_host'] = ENV['REDIS_HOST']
    gitlab_rails['redis_port'] = ENV['REDIS_PORT']
    gitlab_rails['redis_password'] = ENV['REDIS_PASSWORD']
    gitlab_rails['redis_db'] = ENV['REDIS_DB']

    # Nginx
    nginx['enable'] = true
    nginx['client_max_body_size'] = '100m'

    # Registry
    registry['enable'] = true
    registry['host'] = "registry.gitlab.local"
    registry['port'] = 5050
    registry['storage_path'] = "/registry"
    registry_external_url "http://registry.gitlab.local:5050"

    # S3/MinIO Object Storage
    gitlab_rails['object_store']['enabled'] = true
    gitlab_rails['object_store']['connection'] = {
      'provider' => 'AWS',
      's3_region' => ENV['AWS_S3_REGION'],
      'endpoint' => ENV['AWS_S3_ENDPOINT'],
      'aws_access_key_id' => ENV['AWS_ACCESS_KEY_ID'],
      'aws_secret_access_key' => ENV['AWS_SECRET_ACCESS_KEY'],
      'path_style' => true
    }
    gitlab_rails['object_store']['objects']['artifacts']['bucket'] = ENV['AWS_S3_BUCKET']

    # SMTP
    gitlab_rails['smtp_enable'] = true
    gitlab_rails['smtp_address'] = ENV['SMTP_ADDRESS']
    gitlab_rails['smtp_port'] = ENV['SMTP_PORT']
    gitlab_rails['smtp_user_name'] = ENV['SMTP_USER']
    gitlab_rails['smtp_password'] = ENV['SMTP_PASSWORD']
    gitlab_rails['smtp_authentication'] = 'login'
    gitlab_rails['smtp_enable_starttls_auto'] = true
    gitlab_rails['gitlab_email_from'] = ENV['SMTP_USER']
    gitlab_rails['gitlab_email_display_name'] = 'GitLab'

    # GitLab Pages
    pages_external_url "http://pages.gitlab.local/"
    gitlab_pages['enable'] = true
    gitlab_pages['pages_path'] = "/var/opt/gitlab/pages"

    # Security
    gitlab_rails['session_store'] = :redis

    # Performance
    puma['worker_processes'] = 2
    puma['min_threads'] = 2
    puma['max_threads'] = 4

    # SSH
    gitlab_rails['gitlab_shell_ssh_port'] = 2222

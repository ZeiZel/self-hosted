# Namespace
namespace: code

# GitLab Image
image:
  repository: gitlab/gitlab-ce
  tag: "17.0.0-ce.0"
  pullPolicy: IfNotPresent

# GitLab Web компонент
gitlab:
  replicaCount: 1

  service:
    type: ClusterIP
    port: 80
    sshPort: 2222

  resources:
    limits:
      cpu: 2000m
      memory: 2Gi
    requests:
      cpu: 1000m
      memory: 1Gi

  # Конфигурация GitLab
  config:
    external_url: "http://gitlab.local"
    time_zone: "UTC"

    # Отключение встроенных сервисов (используем внешние)
    nginx:
      enabled: true

    postgresql:
      enabled: false

    redis:
      enabled: false

    minio:
      enabled: false

    registry:
      enabled: true
      port: 5050

    # SSH
    gitlab_shell:
      port: 2222

    # Email (SMTP)
    smtp:
      enabled: true
      address: "smtp.gmail.com"
      port: 587
      domain: "example.com"
      enable_starttls_auto: true
      user_name: "your-email@gmail.com"
      password: "your-password"
      authentication: "login"

    # GitLab Pages
    pages:
      enabled: true

    # Container Registry
    registry:
      enabled: true
      storage:
        s3:
          enabled: false

# Persistent Storage
persistence:
  enabled: true
  storageClass: standard

  # GitLab configs и data
  gitlabData:
    enabled: true
    size: 5Gi
    mountPath: /var/opt/gitlab
    accessMode: ReadWriteOnce

  # GitLab registry
  gitlabRegistry:
    enabled: true
    size: 2Gi
    mountPath: /registry
    accessMode: ReadWriteOnce

  # GitLab pages
  gitlabPages:
    enabled: true
    size: 2Gi
    mountPath: /var/opt/gitlab/pages
    accessMode: ReadWriteOnce

# PostgreSQL (внешний)
postgresql:
  external: true
  host: "postgresql.code.svc.cluster.local"
  port: 5432
  username: "gitlab"
  password: "changeme"
  database: "gitlabhq_production"
  ssl: false

# Redis/ValKey (внешний)
redis:
  external: true
  host: "valkey-master.code.svc.cluster.local"
  port: 6379
  password: ""
  database: 0

# MinIO/S3 (для artifact storage и uploads)
objectStorage:
  enabled: true
  type: "minio"
  endpoint: "http://minio.code.svc.cluster.local:9000"
  region: "us-east-1"
  accessKey: "minioadmin"
  secretKey: "minioadmin"
  bucket: "gitlab-artifacts"
  pathStyle: true

# Ingress через Traefik
ingress:
  enabled: true
  className: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.tls: "true"

  hosts:
    - host: gitlab.local
      path: /
    - host: registry.gitlab.local
      path: /

  tls:
    enabled: true
    secretName: gitlab-tls

# GitLab Runner (опционально)
runner:
  enabled: true
  image: gitlab/gitlab-runner:latest
  replicas: 2

  gitlabUrl: "http://gitlab.local"
  runnerToken: "changeme"

  resources:
    limits:
      cpu: 1000m
      memory: 512Mi
    requests:
      cpu: 500m
      memory: 256Mi

  # Kubernetes executor
  kubernetes:
    namespace: "gitlab-runner"
    image: "alpine:latest"
    privileged: true

# Consul интеграция
consul:
  enabled: true
  host: "consul.consul.svc.cluster.local"
  port: 8500
  datacenter: dc1

# Security
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

# Health Checks
probes:
  liveness:
    enabled: true
    path: "/-/health"
    initialDelaySeconds: 60
    periodSeconds: 20
  readiness:
    enabled: true
    path: "/-/readiness"
    initialDelaySeconds: 30
    periodSeconds: 10

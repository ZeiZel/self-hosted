{{- if .Values.logstash.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-config
  namespace: {{ .Release.Namespace }}
data:
  logstash.yml: |
    http.host: "0.0.0.0"
    http.port: 9600
    path.data: /usr/share/logstash/data
    pipeline.workers: 2
    pipeline.batch.size: 125
    pipeline.batch.delay: 50
    xpack.monitoring.enabled: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-pipeline
  namespace: {{ .Release.Namespace }}
data:
  logstash.conf: |
    input {
      beats {
        port => 5044
      }
    }

    filter {
      # Add namespace-based index targeting
      if [kubernetes][namespace] {
        mutate {
          add_field => { "[@metadata][target_index]" => "logstash-%{[kubernetes][namespace]}-%{+YYYY.MM.dd}" }
        }
      } else {
        mutate {
          add_field => { "[@metadata][target_index]" => "logstash-default-%{+YYYY.MM.dd}" }
        }
      }

      # Parse JSON logs (common for containerized services)
      if [message] =~ /^\{/ {
        json {
          source => "message"
          target => "parsed"
          skip_on_invalid_json => true
        }
      }

      # Parse Traefik access logs
      if [kubernetes][labels][app] == "traefik" {
        grok {
          match => { "message" => "%{COMBINEDAPACHELOG}" }
          overwrite => ["message"]
          tag_on_failure => ["_grokparsefailure_traefik"]
        }
      }

      # Timestamp normalization
      date {
        match => ["timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss,SSS", "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"]
        target => "@timestamp"
        tag_on_failure => ["_dateparsefailure"]
      }

      # Remove unnecessary fields to save storage
      mutate {
        remove_field => ["agent.ephemeral_id", "agent.hostname", "agent.id", "ecs.version"]
      }
    }

    output {
      elasticsearch {
        hosts => ["http://elasticsearch:{{ .Values.elasticsearch.service.httpPort }}"]
        index => "%{[@metadata][target_index]}"
        {{- if .Values.elasticsearch.security.enabled }}
        user => "elastic"
        password => "${ELASTICSEARCH_PASSWORD}"
        {{- end }}
      }

      {{- if .Values.logstash.lokiForwarding.enabled }}
      # Dual output to Loki for Grafana integration
      loki {
        url => "{{ .Values.logstash.lokiForwarding.url }}/loki/api/v1/push"
      }
      {{- end }}
    }
{{- end }}

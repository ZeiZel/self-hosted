# Namespace
namespace: code

# Global labels
global:
  labels:
    managed-by: "helm"
    environment: "production"

# PostgreSQL Version selection
postgresqlVersion: "18"  # 18, 17, 16, 15 (supported versions)

# PostgreSQL Image (автоматически выбирается версия)
image:
  repository: postgres
  # tag будет сформирована в зависимости от версии
  # 18-alpine3.20 (latest), 17-alpine3.20 (LTS), 16-alpine3.20, 15-alpine3.20
  pullPolicy: IfNotPresent

# PostgreSQL StatefulSet
postgresql:
  replicaCount: 3

  config:
    superuser: "postgres"
    superuserPassword: "changeme"
    database: "postgres"

    # Performance tuning (оптимизировано для PostgreSQL 18)
    sharedBuffers: "256MB"
    effectiveCacheSize: "1GB"
    maintenanceWorkMem: "64MB"
    checkpointCompletionTarget: 0.9
    walBuffers: "16MB"
    defaultStatisticsTarget: 100
    randomPageCost: 1.1
    effectiveIoConccurrency: 200
    workMem: "4MB"
    minWalSize: "1GB"
    maxWalSize: "4GB"
    maxConnections: 200
    maxWalSenders: 5
    maxReplicationSlots: 5
    walKeepSize: "1GB"

    # PostgreSQL 18+ параметры
    enableIncrementalSort: true
    enablePartitionPruning: true
    enableAsyncAppend: true
    enableParallelHash: true
    walLevel: "replica"

    # Logging
    logStatement: "all"
    logConnections: true
    logDisconnections: true
    logDuration: true
    logLockWaits: true
    logCheckpoints: true
    logAutovacuum: true
    logErrorVerbosity: "verbose"

  service:
    type: ClusterIP
    port: 5432
    annotations: {}

  resources:
    limits:
      cpu: 2000m
      memory: 2Gi
    requests:
      cpu: 1000m
      memory: 1Gi

# Patroni HA конфигурация
patroni:
  enabled: true
  backend: "consul"
  consulConfig:
    host: "consul.consul.svc.cluster.local"
    port: 8500
    datacenter: "dc1"
    service: "postgresql"
    tags:
      - postgresql
      - database
      - "{{ .postgresqlVersion }}"

# Persistent Storage
persistence:
  enabled: true
  storageClass: standard

  data:
    enabled: true
    size: 100Gi
    mountPath: /var/lib/postgresql/data
    accessMode: ReadWriteOnce

  wal:
    enabled: true
    size: 50Gi
    mountPath: /var/lib/postgresql/wal
    accessMode: ReadWriteOnce

  backups:
    enabled: true
    size: 100Gi
    mountPath: /backups
    accessMode: ReadWriteOnce

# Replication
replication:
  enabled: true
  streamingReplication: true
  synchronousCommit: true
  syncReplicaCount: 1

# Backup конфигурация
backup:
  enabled: true

  pgbackrest:
    enabled: true
    retention: 7

    storage:
      type: "s3"
      s3Bucket: "postgresql-backups"
      s3Endpoint: "http://minio.code.svc.cluster.local:9000"
      s3AccessKey: "minioadmin"
      s3SecretKey: "minioadmin"
      s3Region: "us-east-1"

  schedule: "0 2 * * *"

# Maintenance Jobs
maintenance:
  enabled: true

  vacuum:
    enabled: true
    schedule: "0 3 * * *"

  analyze:
    enabled: true
    schedule: "0 4 * * *"

  incrementalBackup:
    enabled: true
    schedule: "0 1 * * *"

# PgAdmin (веб-интерфейс)
pgadmin:
  enabled: true

  image:
    repository: dpage/pgadmin4
    tag: "latest"

  service:
    type: ClusterIP
    port: 80

  config:
    email: "admin@example.com"
    password: "admin"

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# PgBouncer (Connection pooling)
pgbouncer:
  enabled: true

  image:
    repository: bitnami/pgbouncer
    tag: "1.23.1"  # Latest stable version

  replicas: 2

  config:
    poolMode: "transaction"
    maxClientConn: 1000
    defaultPoolSize: 25
    minPoolSize: 10
    reservePoolSize: 5
    reservePoolTimeoutAction: "ROLLBACK"

  service:
    type: ClusterIP
    port: 6432

  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 250m
      memory: 128Mi

# Monitoring (Prometheus)
monitoring:
  enabled: true

  exporter:
    enabled: true
    image: prometheuscommunity/postgres-exporter
    tag: "v0.15.0"  # Latest stable
    port: 9187
    resources:
      limits:
        cpu: 250m
        memory: 128Mi
      requests:
        cpu: 100m
        memory: 64Mi

# Ingress
ingress:
  enabled: true
  className: traefik

  pgadmin:
    enabled: true
    host: pgadmin.local
    path: /
    tls:
      enabled: true
      secretName: postgresql-tls

# Consul
consul:
  enabled: true
  host: "consul.consul.svc.cluster.local"
  port: 8500
  datacenter: dc1

# Security
securityContext:
  runAsUser: 999
  runAsGroup: 999
  fsGroup: 999

# Tests
tests:
  enabled: true

  image:
    repository: postgres

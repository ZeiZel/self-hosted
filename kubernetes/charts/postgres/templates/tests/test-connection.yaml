apiVersion: v1
kind: Pod
metadata:
  name: {{ include "postgresql.fullname" . }}-test-connection
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "postgresql.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded,hook-failed
spec:
  serviceAccountName: {{ include "postgresql.fullname" . }}
  containers:
    - name: postgresql-test
      image: "{{ .Values.tests.image.repository }}:{{ .Values.tests.image.tag }}"

      command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Testing PostgreSQL connection..."
          pg_isready -U {{ .Values.postgresql.config.superuser }} \
            -h {{ include "postgresql.serviceName" . }} \
            -p {{ .Values.postgresql.service.port }}
          echo "âœ“ PostgreSQL connection test passed!"

      env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "postgresql.secretName" . }}
              key: POSTGRES_PASSWORD

  restartPolicy: Never

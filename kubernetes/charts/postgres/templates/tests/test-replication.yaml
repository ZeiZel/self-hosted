{{- if gt (int .Values.postgresql.replicaCount) 1 }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "postgresql.fullname" . }}-test-replication
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "postgresql.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded,hook-failed
spec:
  serviceAccountName: {{ include "postgresql.fullname" . }}
  containers:
    - name: replication-test
      image: "{{ .Values.tests.image.repository }}:{{ .Values.tests.image.tag }}"

      command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Testing PostgreSQL replication..."
          REPLICAS=$(psql -U {{ .Values.postgresql.config.superuser }} \
            -h {{ include "postgresql.serviceName" . }} \
            -d {{ .Values.postgresql.config.database }} \
            -t -c "SELECT COUNT(*) FROM pg_stat_replication;")

          if [ "$REPLICAS" -gt 0 ]; then
            echo "✓ Replication test passed! Active replicas: $REPLICAS"
          else
            echo "✗ No active replicas found"
            exit 1
          fi

      env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "postgresql.secretName" . }}
              key: POSTGRES_PASSWORD

  restartPolicy: Never
{{- end }}

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "postgresql.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "postgresql.componentLabels" . | nindent 4 }}
    postgresql.version: "{{ include "postgresql.version" . }}"
spec:
  serviceName: {{ include "postgresql.headlessServiceName" . }}
  replicas: {{ .Values.postgresql.replicaCount }}
  selector:
    matchLabels:
      {{- include "postgresql.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "postgresql.componentLabels" . | nindent 8 }}
        postgresql.version: "{{ include "postgresql.version" . }}"
      annotations:
        {{- if .Values.consul.enabled }}
        consul.hashicorp.com/connect-inject: "true"
        consul.hashicorp.com/connect-service: "postgresql"
        consul.hashicorp.com/connect-service-port: "5432"
        {{- end }}
        # Prometheus metrics (requires postgres_exporter sidecar)
        prometheus.io/scrape: "true"
        prometheus.io/port: "9187"
        prometheus.io/path: "/metrics"
    spec:
      securityContext:
        {{- toYaml .Values.securityContext | nindent 8 }}

      serviceAccountName: {{ include "postgresql.fullname" . }}

      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - {{ include "postgresql.name" . }}
                topologyKey: kubernetes.io/hostname

      containers:
        - name: postgresql
          image: "{{ .Values.image.repository }}:{{ include "postgresql.imageTag" . }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}

          ports:
            - containerPort: 5432
              name: postgresql

          env:
            - name: PGDATA
              value: "{{ .Values.persistence.data.mountPath }}/pgdata"
            - name: POSTGRES_VERSION
              value: "{{ include "postgresql.version" . }}"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "postgresql.secretName" . }}
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: {{ include "postgresql.secretName" . }}
                  key: POSTGRES_USER
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: {{ include "postgresql.secretName" . }}
                  key: POSTGRES_DB

          resources:
            {{- toYaml .Values.postgresql.resources | nindent 12 }}

          volumeMounts:
            - name: data
              mountPath: {{ .Values.persistence.data.mountPath }}
            - name: config
              mountPath: /etc/postgresql
            {{- if .Values.persistence.wal.enabled }}
            - name: wal
              mountPath: {{ .Values.persistence.wal.mountPath }}
            {{- end }}
            {{- if .Values.persistence.backups.enabled }}
            - name: backups
              mountPath: {{ .Values.persistence.backups.mountPath }}
            {{- end }}

          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - pg_isready -U {{ .Values.postgresql.config.superuser }}
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - pg_isready -U {{ .Values.postgresql.config.superuser }}
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3

        {{- if .Values.monitoring.exporter.enabled }}
        - name: postgres-exporter
          image: "{{ .Values.monitoring.exporter.image }}:{{ .Values.monitoring.exporter.tag }}"
          imagePullPolicy: IfNotPresent

          ports:
            - containerPort: {{ .Values.monitoring.exporter.port }}
              name: metrics

          env:
            - name: DATA_SOURCE_NAME
              value: "postgresql://{{ .Values.postgresql.config.superuser }}:$(POSTGRES_PASSWORD)@localhost:5432/{{ .Values.postgresql.config.database }}?sslmode=disable"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "postgresql.secretName" . }}
                  key: POSTGRES_PASSWORD

          resources:
            {{- toYaml .Values.monitoring.exporter.resources | nindent 12 }}
        {{- end }}

      volumes:
        - name: config
          configMap:
            name: {{ include "postgresql.configMapName" . }}

  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - {{ .Values.persistence.data.accessMode }}
        storageClassName: {{ .Values.persistence.storageClass }}
        resources:
          requests:
            storage: {{ .Values.persistence.data.size }}

    {{- if .Values.persistence.wal.enabled }}
    - metadata:
        name: wal
      spec:
        accessModes:
          - {{ .Values.persistence.wal.accessMode }}
        storageClassName: {{ .Values.persistence.storageClass }}
        resources:
          requests:
            storage: {{ .Values.persistence.wal.size }}
    {{- end }}

    {{- if .Values.persistence.backups.enabled }}
    - metadata:
        name: backups
      spec:
        accessModes:
          - {{ .Values.persistence.backups.accessMode }}
        storageClassName: {{ .Values.persistence.storageClass }}
        resources:
          requests:
            storage: {{ .Values.persistence.backups.size }}
    {{- end }}

apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-config
  namespace: {{ .Values.namespace }}
data:
  vault.hcl: |
    ui = true

    listener "tcp" {
      address = "[::]:8200"
      cluster_address = "[::]:8201"
      tls_disable = true
    }

    # Integrated Storage (Raft)
    storage "raft" {
      path    = "/vault/data"
      node_id = "${VAULT_RAFT_NODE_ID}"

      {{- if .Values.server.ha.enabled }}
      retry_join {
        leader_api_addr = "http://vault-0.vault-internal:8200"
      }
      retry_join {
        leader_api_addr = "http://vault-1.vault-internal:8200"
      }
      retry_join {
        leader_api_addr = "http://vault-2.vault-internal:8200"
      }
      {{- end }}
    }

    # Audit logging
    audit {
      file {
        path = "/vault/logs/audit.log"
      }
    }

    # High Availability
    ha_storage "raft" {
      path    = "/vault/data"
      node_id = "${VAULT_RAFT_NODE_ID}"
    }

    {{- if .Values.consul.enabled }}
    # Consul Service Registration
    service_registration "consul" {
      address      = "{{ .Values.consul.host }}"
      service      = "vault"
      service_tags = "vault"
      check_interval = "10s"
      check_timeout = "5s"
    }
    {{- end }}

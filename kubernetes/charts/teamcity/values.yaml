# Namespace
namespace: code

create:
  namespace: true

# TeamCity Server Image
server:
  image:
    repository: jetbrains/teamcity-server
    tag: "2024.03"
    pullPolicy: IfNotPresent

  replicaCount: 1

  service:
    type: ClusterIP
    port: 8111

  resources:
    limits:
      cpu: 2000m
      memory: 2Gi
    requests:
      cpu: 1000m
      memory: 1Gi

  # Persistent Storage
  persistence:
    enabled: true
    storageClass: standard
    size: 5Gi
    mountPath: /data/teamcity_server/datadir

# TeamCity Agent Image
agent:
  image:
    repository: jetbrains/teamcity-agent
    tag: "2024.03"
    pullPolicy: IfNotPresent

  replicaCount: 2

  service:
    type: ClusterIP
    port: 9090

  resources:
    limits:
      cpu: 2000m
      memory: 2Gi
    requests:
      cpu: 1000m
      memory: 1Gi

  # Persistent Storage для агентов
  persistence:
    enabled: true
    storageClass: standard
    size: 3Gi
    mountPath: /data/teamcity_agent/work

# PostgreSQL (внешний)
postgresql:
  external: true
  host: "postgresql.db.svc.cluster.local"
  port: 5432
  username: "teamcity"
  password: "changeme"
  database: "teamcity"
  ssl: false

# Ingress через Traefik
ingress:
  enabled: true
  className: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure

  host: teamcity.local
  path: /

  tls:
    enabled: true
    secretName: teamcity-tls

# Consul интеграция
consul:
  enabled: true
  host: "consul.consul.svc.cluster.local"
  port: 8500
  datacenter: dc1
  tags:
    - teamcity
    - ci-cd
    - build-server

# Security
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

# Health Checks
probes:
  liveness:
    enabled: true
    initialDelaySeconds: 180
    periodSeconds: 20
  readiness:
    enabled: true
    initialDelaySeconds: 60
    periodSeconds: 10

# Vault integration (requires Vault policies and secrets to be configured)
# Authentik integration (ForwardAuth via Traefik)
authentik:
  enabled: false
  middleware: "service-authentik-forward-auth@kubernetescrd"
  host: "https://authentik.local"
  outpostPath: "/outpost.goauthentik.io/auth/traefik"

vault:
  enabled: false
  # Note: Before enabling, configure Vault:
  # 1. Create policy for teamcity service
  # 2. Create secret at secret/data/teamcity/secrets
  # 3. Enable Kubernetes auth method in Vault
  # 4. Create role binding ServiceAccount to Vault policy
  # See: kubernetes/docs/VAULT_MIGRATION.md

# Network Policy
networkPolicy:
  enabled: true
  egressRules:
    allowDatabases: true
    allowConsul: true
    allowVault: true
    allowAuthentik: false
  ingress: []
  egress: []

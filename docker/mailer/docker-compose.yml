version: '3.8'

services:
  stalwart:
    image: stalwartlabs/stalwart:latest
    ports:
      - "25:25"      # SMTP
      - "465:465"    # SMTPS
      - "587:587"    # Submission
      - "143:143"    # IMAP
      - "993:993"    # IMAPS
      - "443:443"    # HTTPS
    environment:
      - STALWART_HOSTNAME=mail.example.com
      - STALWART_DOMAINS=example.com
    volumes:
      - mail_data:/opt/stalwart/data
      - mail_config:/opt/stalwart/config
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
          - node.labels.mail == true
      resources:
        limits:
          cpus: "1"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.stalwart-admin.rule=Host(`mail-admin.example.com`)"
        - "traefik.http.routers.stalwart-admin.service=stalwart-admin"
        - "traefik.http.services.stalwart-admin.loadbalancer.server.port=8080"
        - "traefik.http.routers.stalwart-jmap.rule=Host(`mail.example.com`) && PathPrefix(`/jmap`)"
        - "traefik.http.routers.stalwart-jmap.service=stalwart-jmap"
        - "traefik.http.services.stalwart-jmap.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - mail_network

volumes:
  mail_data:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr=nfs-server,nolock,soft,rw"
      device: ":/path/to/mail/data"
  mail_config:
    driver: local

secrets:
  stalwart_admin_password:
    external: true
  ssl_cert:
    external: true
  ssl_key:
    external: true

networks:
  mail_network:
    driver: overlay
    attachable: true
    driver_opts:
      encrypted: "true"

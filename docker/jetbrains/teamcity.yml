# https://github.com/JetBrains/teamcity-docker-samples/blob/master/compose-ubuntu/docker-compose.yml

# ./buildserver_pgdata - Posgres DB data
# ./data_dir - TeamCity data directory
# ./teamcity-server-logs - logs of primary TeamCity server
# ./agents/conf - configuration directory for the first build agent

services:
  teamcity:
    image: jetbrains/teamcity-server:latest
    ports:
      - "8112:8111"
    volumes:
      - ${PWD}/volumes/data_dir:/data/teamcity_server/datadir
      - ${PWD}/volumes/teamcity/logs:/opt/teamcity/logs
    depends_on:
      - postgresql

  # can use multiple of agents in multinode
  teamcity-agent:
    image: jetbrains/teamcity-agent:latest-linux-sudo
    privileged: true
    volumes:
      - ./docker/jetbrains/agents/agent/conf:/data/teamcity_agent/conf
    environment:
      - DOCKER_IN_DOCKER=start
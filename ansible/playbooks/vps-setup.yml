---
- name: VPS Initial Setup and Hardening
  hosts: gateway
  become: yes
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    - name: Install essential packages
      apt:
        name:
          - ufw
          - fail2ban
          - htop
          - vim
          - curl
          - wget
          - git
          - python3-pip
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
          - build-essential
          - software-properties-common
        state: present

    - name: Configure UFW defaults
      ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: 'incoming', policy: 'deny' }
        - { direction: 'outgoing', policy: 'allow' }

    - name: Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: Allow HTTP/HTTPS
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - '80'
        - '443'
        - '8080'  # Traefik dashboard

    - name: Allow WireGuard
      ufw:
        rule: allow
        port: '51820'
        proto: udp

    - name: Enable UFW
      ufw:
        state: enabled

    - name: Configure fail2ban
      copy:
        dest: /etc/fail2ban/jail.local
        content: |
          [DEFAULT]
          bantime = 3600
          findtime = 600
          maxretry = 5

          [sshd]
          enabled = true
          port = 22
          logpath = /var/log/auth.log
          maxretry = 3
      notify: restart fail2ban

    - name: Enable and start fail2ban
      systemd:
        name: fail2ban
        enabled: yes
        state: started

    - name: Set timezone to UTC
      timezone:
        name: UTC

    - name: Configure sysctl for networking and performance
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
        sysctl_file: /etc/sysctl.d/99-custom.conf
      loop:
        - { key: 'net.ipv4.ip_forward', value: '1' }
        - { key: 'net.ipv4.conf.all.forwarding', value: '1' }
        - { key: 'net.ipv6.conf.all.forwarding', value: '1' }
        - { key: 'net.core.rmem_max', value: '134217728' }
        - { key: 'net.core.wmem_max', value: '134217728' }
        - { key: 'net.ipv4.tcp_rmem', value: '4096 87380 67108864' }
        - { key: 'net.ipv4.tcp_wmem', value: '4096 65536 67108864' }
        - { key: 'net.ipv4.tcp_congestion_control', value: 'bbr' }
        - { key: 'net.core.default_qdisc', value: 'fq' }
        - { key: 'net.ipv4.tcp_mtu_probing', value: '1' }
        - { key: 'fs.file-max', value: '2097152' }
        - { key: 'fs.inotify.max_user_watches', value: '524288' }

    - name: Disable unnecessary services
      systemd:
        name: "{{ item }}"
        enabled: no
        state: stopped
      loop:
        - snapd
      failed_when: false

    - name: Set up automatic security updates
      apt:
        name: unattended-upgrades
        state: present

    - name: Configure unattended-upgrades
      copy:
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        content: |
          Unattended-Upgrade::Allowed-Origins {
              "${distro_id}:${distro_codename}";
              "${distro_id}:${distro_codename}-security";
              "${distro_id}ESMApps:${distro_codename}-apps-security";
              "${distro_id}ESM:${distro_codename}-infra-security";
          };
          Unattended-Upgrade::AutoFixInterruptedDpkg "true";
          Unattended-Upgrade::MinimalSteps "true";
          Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
          Unattended-Upgrade::Remove-Unused-Dependencies "true";
          Unattended-Upgrade::Automatic-Reboot "false";

    - name: Create swap file (if not exists)
      command: fallocate -l 2G /swapfile
      args:
        creates: /swapfile

    - name: Set swap file permissions
      file:
        path: /swapfile
        mode: '0600'

    - name: Format swap file
      command: mkswap /swapfile
      when: ansible_swaptotal_mb == 0

    - name: Enable swap
      command: swapon /swapfile
      when: ansible_swaptotal_mb == 0

    - name: Add swap to fstab
      lineinfile:
        path: /etc/fstab
        line: '/swapfile none swap sw 0 0'
        state: present

    - name: Set swappiness
      sysctl:
        name: vm.swappiness
        value: '10'
        state: present

    - name: Display system info
      debug:
        msg:
          - "VPS setup complete!"
          - "Hostname: {{ ansible_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Kernel: {{ ansible_kernel }}"
          - "IP: {{ ansible_default_ipv4.address }}"
          - "Memory: {{ ansible_memtotal_mb }}MB"
          - "CPUs: {{ ansible_processor_vcpus }}"

  handlers:
    - name: restart fail2ban
      systemd:
        name: fail2ban
        state: restarted

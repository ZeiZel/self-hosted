---
# Main Ansible Playbook for Self-Hosted Infrastructure
#
# This playbook orchestrates the complete infrastructure setup:
# 1. Pre-flight validation
# 2. Proxmox setup and VM provisioning
# 3. Server configuration (base, security, VPS-specific)
# 4. Kubernetes deployment
# 5. Infrastructure services
# 6. VPN connectivity
#
# Usage:
#   Full deployment:
#     ansible-playbook -i inventory/hosts.ini all.yml
#
#   Specific tags:
#     ansible-playbook -i inventory/hosts.ini all.yml --tags proxmox-setup
#     ansible-playbook -i inventory/hosts.ini all.yml --tags terraform
#     ansible-playbook -i inventory/hosts.ini all.yml --tags base,security
#     ansible-playbook -i inventory/hosts.ini all.yml --tags kubespray
#
# Available tags:
#   Proxmox:  proxmox, proxmox-setup, terraform, post-provision
#   Server:   server, base, security, vps
#   K8s:      prepare, kubespray, helmfile, pangolin, monitoring
#   Apps:     apps, vault, authentik, gitlab, jetbrains, hub, youtrack, teamcity
#             coder, bytebase, harbor, affine, nextcloud, n8n, kestra
#             stoat, stalwart, vaultwarden, rybbit

- name: Pre-flight validation
  hosts: localhost
  connection: local
  gather_facts: false
  tags: [always]
  tasks:
    - name: Check required tools are installed
      command: "which {{ item }}"
      register: tool_check
      failed_when: tool_check.rc != 0
      changed_when: false
      loop:
        - kubectl
        - helm
        - helmfile
        - ansible
        - sops
        - gpg
      tags: [always]

    - name: Check Ansible version
      command: ansible --version
      register: ansible_version
      changed_when: false
      failed_when: ansible_version.rc != 0
      tags: [always]

    - name: Display validation success
      debug:
        msg: "Pre-flight validation passed - all required tools are available"
      tags: [always]

# =============================================================================
# PROXMOX - Setup and VM Provisioning
# =============================================================================
- name: Proxmox Setup
  hosts: proxmox_nodes
  become: true
  gather_facts: true
  tags: [proxmox, proxmox-setup]
  roles:
    - role: proxmox
      tags: [proxmox-setup]

- name: Provision VMs with Terraform
  hosts: localhost
  connection: local
  gather_facts: false
  tags: [proxmox, terraform, provision]
  roles:
    - role: proxmox
      tags: [terraform]

- name: Configure Provisioned VMs
  hosts: proxmox_vms
  become: true
  gather_facts: true
  tags: [proxmox, post-provision]
  roles:
    - role: proxmox
      tags: [post-provision]

# =============================================================================
# HOST SETUP - Local Machine
# =============================================================================
- name: Host Setup
  hosts: local
  become: true
  gather_facts: true
  tags: [prepare]
  roles:
    - role: setup_host

# =============================================================================
# KUBERNETES MASTER NODES
# =============================================================================
- name: Master Nodes
  hosts: k8s_masters
  become: true
  gather_facts: true
  tags: [prepare, kubespray, helmfile, pangolin]
  vars:
    server_type: node
  roles:
    - role: server
      tags: [prepare, base, security]
    - role: docker
      tags: [prepare, docker]
    - role: kubespray
      tags: [kubespray, master]
      type: node
    - role: infrastructure
      tags: [helmfile, infrastructure, master]
    - role: pangolin
      tags: [pangolin, node]

# =============================================================================
# KUBERNETES WORKER NODES
# =============================================================================
- name: Worker Nodes
  hosts: k8s_workers
  become: true
  gather_facts: true
  tags: [prepare, kubespray, helmfile, pangolin]
  vars:
    server_type: node
  roles:
    - role: server
      tags: [prepare, base, security]
    - role: docker
      tags: [prepare, docker]
    - role: kubespray
      tags: [kubespray, worker]
      type: node
    - role: infrastructure
      tags: [helmfile, infrastructure, worker]
    - role: pangolin
      tags: [pangolin, node]

# =============================================================================
# GATEWAY VPS
# =============================================================================
- name: Gateway VPS
  hosts: gateway
  become: true
  gather_facts: true
  tags: [vps, prepare, kubespray, helmfile, pangolin]
  vars:
    server_type: vps
  roles:
    - role: server
      tags: [prepare, base, security, vps]
    - role: docker
      tags: [prepare, docker]
    - role: kubespray
      tags: [kubespray, gateway, worker]
      type: gateway
    - role: infrastructure
      tags: [helmfile, infrastructure, gateway]
    - role: pangolin
      tags: [pangolin, gateway]

# =============================================================================
# APPLICATIONS - Post-installation configuration
# =============================================================================
- name: Applications Post-Configuration
  hosts: k8s_masters[0]
  become: false
  gather_facts: false
  tags: [apps]
  roles:
    - role: apps
      tags: [apps]

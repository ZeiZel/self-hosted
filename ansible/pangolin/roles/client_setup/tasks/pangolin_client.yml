---
- name: Ensure Pangolin client directory exists
  file:
    path: "{{ pangolin_client_install_dir | default('/opt/pangolin-client') }}"
    state: directory
    mode: '0755'

- name: Check if Pangolin client is already configured
  stat:
    path: "{{ pangolin_client_install_dir }}/docker-compose.yml"
  register: pangolin_client_config

- name: Deploy Pangolin client docker-compose
  template:
    src: docker-compose.yml.j2
    dest: "{{ pangolin_client_install_dir }}/docker-compose.yml"
    mode: '0644'
  when: not pangolin_client_config.stat.exists or pangolin_client_force_redeploy | default(false)
  notify: restart pangolin client

- name: Start Pangolin client
  community.docker.docker_compose_v2:
    project_src: "{{ pangolin_client_install_dir }}"
    state: present
  when: not pangolin_client_config.stat.exists or pangolin_client_force_redeploy | default(false)

- name: Wait for Pangolin client to be ready
  uri:
    url: "http://localhost:{{ pangolin_client_port | default(3001) }}/api/v1/"
    status_code: 200
  retries: 30
  delay: 5
  register: result
  until: result.status == 200
  ignore_errors: yes

- name: Register client with Pangolin server
  uri:
    url: "https://{{ pangolin_server_endpoint }}/api/v1/clients/register"
    method: POST
    body_format: json
    body:
      name: "{{ inventory_hostname }}"
      endpoint: "{{ ansible_default_ipv4.address }}"
    status_code: 201
  when: pangolin_auto_register | default(false)
  ignore_errors: yes






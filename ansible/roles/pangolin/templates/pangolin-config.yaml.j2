---
# Pangolin WireGuard VPN Server Configuration
# Generated by Ansible

server:
  # WireGuard interface configuration
  interface:
    name: {{ wireguard_interface }}
    address: {{ wireguard_server_ip }}/{{ wireguard_network | ipaddr('prefix') }}
    listen_port: {{ wireguard_port }}
    private_key: {{ wireguard_server_private_key }}

  # Network configuration
  network:
    subnet: {{ wireguard_network }}
    dns:
      - 1.1.1.1
      - 8.8.8.8
    mtu: 1420

  # IP allocation for clients
  peers:
    # K8s master nodes (10.99.0.10-19)
{% for host in groups['k8s_masters'] %}
    - public_key: {{ vault.vpn.pangolin.client_keys[host].public_key }}
      preshared_key: {{ wireguard_preshared_key }}
      allowed_ips:
        - {{ pangolin_node_ip_prefix }}.{{ 10 + loop.index0 }}/32
      persistent_keepalive: 25
      comment: {{ host }}
{% endfor %}

    # K8s worker nodes (10.99.0.20-29)
{% for host in groups['k8s_workers'] %}
    - public_key: {{ vault.vpn.pangolin.client_keys[host].public_key }}
      preshared_key: {{ wireguard_preshared_key }}
      allowed_ips:
        - {{ pangolin_node_ip_prefix }}.{{ 20 + loop.index0 }}/32
      persistent_keepalive: 25
      comment: {{ host }}
{% endfor %}

  # Firewall rules
  firewall:
    enabled: true
    default_policy: drop
    rules:
      - action: accept
        protocol: tcp
        port: 22
        comment: SSH
      - action: accept
        protocol: tcp
        port: 80
        comment: HTTP
      - action: accept
        protocol: tcp
        port: 443
        comment: HTTPS
      - action: accept
        protocol: udp
        port: {{ wireguard_port }}
        comment: WireGuard
      - action: accept
        source: {{ wireguard_network }}
        comment: Allow VPN network

  # NAT configuration
  nat:
    enabled: true
    masquerade: true
    interface: {{ ansible_default_ipv4.interface }}

  # Logging
  logging:
    level: info
    file: /var/log/pangolin/server.log
    max_size: 100M
    max_backups: 5

# Health check
health_check:
  enabled: true
  interval: 30s
  timeout: 10s

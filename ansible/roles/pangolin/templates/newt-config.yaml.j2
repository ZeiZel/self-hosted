---
# Newt WireGuard VPN Client Configuration
# Generated by Ansible
# Node: {{ inventory_hostname }}

client:
  # WireGuard interface configuration
  interface:
    name: {{ wireguard_interface }}
    address: {{ node_wireguard_ip }}/{{ wireguard_network | ipaddr('prefix') }}
    private_key: {{ wireguard_client_private_key }}
    mtu: 1420

  # DNS configuration
  dns:
    servers:
      - 1.1.1.1
      - 8.8.8.8
    search_domains:
      - cluster.local
      - svc.cluster.local

  # Server/peer configuration
  peer:
    public_key: {{ wireguard_gateway_public_key }}
    preshared_key: {{ wireguard_preshared_key }}
    endpoint: {{ pangolin_gateway_endpoint }}
    allowed_ips:
      - 0.0.0.0/0
      - ::/0
    persistent_keepalive: 25

  # Routing
  routing:
    table: auto
    fwmark: 51820
    routes:
      - destination: {{ wireguard_network }}
        gateway: {{ wireguard_server_ip }}
        metric: 100

  # Connection management
  connection:
    retry_interval: 15s
    max_retries: 0  # Infinite retries
    timeout: 30s
    health_check:
      enabled: true
      interval: 60s
      ping_target: {{ wireguard_server_ip }}

  # Logging
  logging:
    level: info
    file: /var/log/newt/{{ inventory_hostname }}.log
    max_size: 50M
    max_backups: 3

# Hooks (optional)
hooks:
  pre_up:
    - /bin/echo "Bringing up WireGuard tunnel on {{ inventory_hostname }}"
  post_up:
    - /bin/ip route add {{ wireguard_network }} via {{ wireguard_server_ip }} dev {{ wireguard_interface }} || true
  pre_down:
    - /bin/echo "Bringing down WireGuard tunnel on {{ inventory_hostname }}"
  post_down:
    - /bin/ip route del {{ wireguard_network }} via {{ wireguard_server_ip }} dev {{ wireguard_interface }} || true

---
- name: Create temporary directory for cloud image
  file:
    path: /tmp/proxmox-cloud-images
    state: directory
    mode: '0755'
  tags: [proxmox, template]

- name: Download Ubuntu cloud image
  get_url:
    url: "{{ proxmox_ubuntu_iso_url }}"
    dest: "/tmp/proxmox-cloud-images/ubuntu-{{ proxmox_ubuntu_version }}-cloudimg-amd64.img"
    mode: '0644'
  register: cloud_image_download
  tags: [proxmox, template]

- name: Check if template VM already exists
  command: qm status {{ proxmox_template_vmid }}
  register: template_check
  failed_when: false
  changed_when: false
  tags: [proxmox, template]

- name: Remove existing template if present
  command: qm destroy {{ proxmox_template_vmid }}
  when: template_check.rc == 0
  tags: [proxmox, template]

- name: Create VM for template
  command: >
    qm create {{ proxmox_template_vmid }}
    --name {{ proxmox_template_name }}
    --memory 2048
    --cores 2
    --net0 virtio,bridge={{ proxmox_network_bridge_k8s }}
  tags: [proxmox, template]

- name: Import cloud image as VM disk
  command: >
    qm importdisk {{ proxmox_template_vmid }}
    /tmp/proxmox-cloud-images/ubuntu-{{ proxmox_ubuntu_version }}-cloudimg-amd64.img
    {{ proxmox_storage_pool }}
  tags: [proxmox, template]

- name: Attach disk to VM
  command: >
    qm set {{ proxmox_template_vmid }}
    --scsihw virtio-scsi-pci
    --scsi0 {{ proxmox_storage_pool }}:vm-{{ proxmox_template_vmid }}-disk-0
  tags: [proxmox, template]

- name: Configure VM boot settings
  command: >
    qm set {{ proxmox_template_vmid }}
    --boot c
    --bootdisk scsi0
  tags: [proxmox, template]

- name: Add cloud-init drive
  command: >
    qm set {{ proxmox_template_vmid }}
    --ide2 {{ proxmox_storage_pool }}:cloudinit
  tags: [proxmox, template]

- name: Configure serial console
  command: >
    qm set {{ proxmox_template_vmid }}
    --serial0 socket
    --vga serial0
  tags: [proxmox, template]

- name: Enable QEMU guest agent
  command: qm set {{ proxmox_template_vmid }} --agent enabled=1
  tags: [proxmox, template]

- name: Convert VM to template
  command: qm template {{ proxmox_template_vmid }}
  tags: [proxmox, template]

- name: Verify template creation
  command: qm config {{ proxmox_template_vmid }}
  register: template_config
  changed_when: false
  tags: [proxmox, template]

- name: Display template configuration
  debug:
    msg: "Template {{ proxmox_template_name }} ({{ proxmox_template_vmid }}) created successfully"
  tags: [proxmox, template]

- name: Cleanup cloud image file
  file:
    path: "/tmp/proxmox-cloud-images/ubuntu-{{ proxmox_ubuntu_version }}-cloudimg-amd64.img"
    state: absent
  tags: [proxmox, template]

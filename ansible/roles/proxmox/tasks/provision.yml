---
- name: Clone VMs from template
  command: >
    qm clone {{ proxmox_template_vmid }} {{ item.vmid }}
    --name {{ item.name }}
    --full
  loop: "{{ proxmox_vms }}"
  when: item.vmid is defined
  register: vm_clone
  failed_when: vm_clone.rc != 0 and 'already exists' not in vm_clone.stderr
  tags: [proxmox, provision]

- name: Configure VM CPU
  command: qm set {{ item.vmid }} --cores {{ item.cores }}
  loop: "{{ proxmox_vms }}"
  tags: [proxmox, provision]

- name: Configure VM memory
  command: qm set {{ item.vmid }} --memory {{ item.memory }}
  loop: "{{ proxmox_vms }}"
  tags: [proxmox, provision]

- name: Resize VM disk
  command: qm resize {{ item.vmid }} scsi0 {{ item.disk }}
  loop: "{{ proxmox_vms }}"
  tags: [proxmox, provision]

- name: Generate cloud-init user config for each VM
  template:
    src: cloud-init-user.yml.j2
    dest: "/tmp/cloud-init-{{ item.name }}.yml"
    mode: '0644'
  vars:
    vm_name: "{{ item.name }}"
    vm_ip: "{{ item.ip }}"
  loop: "{{ proxmox_vms }}"
  tags: [proxmox, provision]

- name: Configure cloud-init for VMs
  command: >
    qm set {{ item.vmid }}
    --cicustom "user=local:snippets/cloud-init-{{ item.name }}.yml"
    --ipconfig0 ip={{ item.ip }}/24,gw={{ proxmox_vm_network_gateway }}
    --nameserver {{ proxmox_vm_network_dns }}
  loop: "{{ proxmox_vms }}"
  tags: [proxmox, provision]

- name: Copy cloud-init configs to Proxmox snippets directory
  copy:
    src: "/tmp/cloud-init-{{ item.name }}.yml"
    dest: "/var/lib/vz/snippets/cloud-init-{{ item.name }}.yml"
    remote_src: yes
    owner: root
    group: root
    mode: '0644'
  loop: "{{ proxmox_vms }}"
  tags: [proxmox, provision]

- name: Start VMs
  command: qm start {{ item.vmid }}
  loop: "{{ proxmox_vms }}"
  register: vm_start
  failed_when: vm_start.rc != 0 and 'already running' not in vm_start.stderr
  tags: [proxmox, provision]

- name: Wait for VMs to boot
  wait_for:
    timeout: 60
  tags: [proxmox, provision]

- name: Wait for SSH to become available on VMs
  wait_for:
    host: "{{ item.ip }}"
    port: 22
    delay: 10
    timeout: 300
    state: started
  loop: "{{ proxmox_vms }}"
  tags: [proxmox, provision]

- name: Verify VM status
  command: qm status {{ item.vmid }}
  loop: "{{ proxmox_vms }}"
  register: vm_status
  changed_when: false
  tags: [proxmox, provision]

- name: Display VM provisioning summary
  debug:
    msg:
      - "VM {{ item.item.name }} (ID: {{ item.item.vmid }}): {{ item.stdout }}"
      - "  IP: {{ item.item.ip }}"
      - "  Role: {{ item.item.role }}"
      - "  Resources: {{ item.item.cores }} cores, {{ item.item.memory }}MB RAM, {{ item.item.disk }} disk"
  loop: "{{ vm_status.results }}"
  tags: [proxmox, provision]

- name: Cleanup temporary cloud-init files
  file:
    path: "/tmp/cloud-init-{{ item.name }}.yml"
    state: absent
  loop: "{{ proxmox_vms }}"
  tags: [proxmox, provision]

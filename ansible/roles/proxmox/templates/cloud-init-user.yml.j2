#cloud-config
# Cloud-init configuration for K8s nodes
# Generated by Ansible

hostname: {{ vm_name | default('k8s-node') }}
manage_etc_hosts: true

users:
  - name: {{ proxmox_cloud_init_user }}
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
{% for key in proxmox_cloud_init_ssh_keys %}
      - {{ key }}
{% endfor %}

# Disable root SSH login
disable_root: true

# Package management
package_update: true
package_upgrade: true

packages:
  - qemu-guest-agent
  - python3
  - python3-pip
  - curl
  - wget
  - git
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release

# Network configuration
network:
  version: 2
  ethernets:
    ens18:
      dhcp4: false
      addresses:
        - {{ vm_ip }}/24
      gateway4: {{ proxmox_vm_network_gateway }}
      nameservers:
        addresses:
          - {{ proxmox_vm_network_dns.split(',')[0] }}
          - {{ proxmox_vm_network_dns.split(',')[1] }}

# Enable services
runcmd:
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent

# Set timezone
timezone: Europe/Moscow

# Final message
final_message: "K8s node cloud-init setup complete after $UPTIME seconds"

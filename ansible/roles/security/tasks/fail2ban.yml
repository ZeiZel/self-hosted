---
- name: Check if fail2ban is installed
  command: which fail2ban-server
  register: fail2ban_installed
  changed_when: false
  failed_when: false

- name: Install fail2ban
  apt:
    name: fail2ban
    state: present
    update_cache: yes
  when: fail2ban_installed.rc != 0

- name: Create fail2ban jail.local
  template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    owner: root
    group: root
    mode: '0644'
  notify: restart fail2ban

- name: Check if fail2ban SSH filter exists
  stat:
    path: /etc/fail2ban/filter.d/sshd.local
  register: fail2ban_filter_exists
  changed_when: false

- name: Create fail2ban filter for SSH
  copy:
    content: |
      [Definition]
      failregex = ^%(__prefix_line)s(?:error: PAM: )?Authentication failure for .* from <HOST>\s*$
                  ^%(__prefix_line)s(?:error: PAM: )?User not known to the underlying authentication module for .* from <HOST>\s*$
                  ^%(__prefix_line)sFailed \S+ for .*? from <HOST>(?: port \d+)?(?: ssh\d*)?(: (ruser .*|(\S+ )?User \S+ from \S+))?\s*$
                  ^%(__prefix_line)sROOT LOGIN REFUSED.* from <HOST>\s*$
                  ^%(__prefix_line)s[iI](?:llegal|nvalid) user .* from <HOST>\s*$
                  ^%(__prefix_line)sUser .+ from <HOST> not allowed because not listed in AllowUsers\s*$
                  ^%(__prefix_line)sauthentication failure; logname=\S* uid=\S* euid=\S* tty=\S* ruser=\S* rhost=<HOST>(?:\s+user=.*)?\s*$
                  ^%(__prefix_line)sUser \S+ from <HOST> not allowed because not listed in AllowGroups\s*$
                  ^%(__prefix_line)sUser \S+ from <HOST> not allowed because a group is listed in DenyGroups\s*$
                  ^%(__prefix_line)srefused connect from \S+ \(<HOST>\)\s*$
                  ^%(__prefix_line)sUser .+ from <HOST> not allowed because a group is listed in DenyUsers\s*$
                  ^%(__prefix_line)s(?:error: PAM: )?User .+ from <HOST> not allowed because not listed in AllowUsers\s*$
                  ^%(__prefix_line)s(?:error: PAM: )?User .+ from <HOST> not allowed because a group is listed in DenyUsers\s*$
                  ^%(__prefix_line)s(?:error: PAM: )?User .+ from <HOST> not allowed because not listed in AllowGroups\s*$
                  ^%(__prefix_line)s(?:error: PAM: )?User .+ from <HOST> not allowed because a group is listed in DenyGroups\s*$
      ignoreregex =
    dest: /etc/fail2ban/filter.d/sshd.local
    owner: root
    group: root
    mode: '0644'
  notify: restart fail2ban

- name: Enable and start fail2ban
  systemd:
    name: fail2ban
    enabled: yes
    state: started

- name: Check fail2ban status
  command: fail2ban-client status
  register: fail2ban_status
  changed_when: false

- name: Display fail2ban status
  debug:
    var: fail2ban_status.stdout_lines

---
# GitLab post-installation configuration
# - Wait for GitLab to be ready
# - Get root password
# - Configure runners
# - Set up integrations

- name: Wait for GitLab webservice to be ready
  command: >
    kubectl wait --for=condition=Ready pod
    -n code -l app=webservice
    --timeout={{ gitlab_wait_timeout }}s
  changed_when: false
  failed_when: false

- name: Wait for GitLab sidekiq to be ready
  command: >
    kubectl wait --for=condition=Ready pod
    -n code -l app=sidekiq
    --timeout={{ gitlab_wait_timeout }}s
  changed_when: false
  failed_when: false

- name: Get GitLab root password from secret
  command: >
    kubectl get secret -n code gitlab-gitlab-initial-root-password
    -o jsonpath='{.data.password}'
  register: gitlab_root_password_b64
  changed_when: false
  failed_when: false
  no_log: true

- name: Decode root password
  set_fact:
    gitlab_root_password: "{{ gitlab_root_password_b64.stdout | b64decode }}"
  when: gitlab_root_password_b64.stdout | length > 0
  no_log: true

- name: Get GitLab runner registration token
  command: >
    kubectl exec -n code deployment/gitlab-webservice-default --
    gitlab-rails runner "puts Gitlab::CurrentSettings.runners_registration_token"
  register: gitlab_runner_token
  changed_when: false
  failed_when: false
  no_log: true

- name: Save GitLab credentials locally
  copy:
    content: |
      GitLab Credentials
      ==================
      URL: {{ gitlab_url }}
      Root User: root
      Root Password: {{ gitlab_root_password }}
      Runner Token: {{ gitlab_runner_token.stdout | default('Not available') }}

      KEEP THIS FILE SECURE!
    dest: "{{ gitlab_credentials_file }}"
    mode: '0600'
  delegate_to: localhost
  when: gitlab_root_password is defined
  no_log: true

- name: Check GitLab health
  uri:
    url: "{{ gitlab_url }}/-/health"
    method: GET
    status_code: [200]
    validate_certs: "{{ gitlab_validate_certs }}"
  register: gitlab_health
  retries: 10
  delay: 30
  until: gitlab_health.status == 200
  failed_when: false

- name: Configure GitLab application settings via API
  when: gitlab_root_password is defined
  block:
    - name: Get GitLab personal access token for root
      uri:
        url: "{{ gitlab_url }}/api/v4/personal_access_tokens"
        method: POST
        body_format: json
        body:
          name: "ansible-setup-token"
          scopes: ["api", "read_user", "read_repository", "write_repository"]
        headers:
          PRIVATE-TOKEN: "{{ gitlab_root_password }}"
        status_code: [200, 201, 401]
        validate_certs: "{{ gitlab_validate_certs }}"
      register: gitlab_pat_response
      failed_when: false

    - name: Set PAT token
      set_fact:
        gitlab_api_token: "{{ gitlab_pat_response.json.token }}"
      when:
        - gitlab_pat_response.status in [200, 201]
        - gitlab_pat_response.json.token is defined
      no_log: true

- name: Create shared runner (if token available)
  when:
    - gitlab_runner_token.stdout is defined
    - gitlab_runner_token.stdout | length > 0
  block:
    - name: Register Kubernetes executor runner
      command: >
        kubectl exec -n code deployment/gitlab-gitlab-runner --
        gitlab-runner register
        --non-interactive
        --url="{{ gitlab_url }}"
        --registration-token="{{ gitlab_runner_token.stdout }}"
        --executor="kubernetes"
        --kubernetes-namespace="code"
        --description="kubernetes-runner"
        --tag-list="kubernetes,docker"
        --run-untagged="true"
        --locked="false"
      register: runner_register
      changed_when: "'Registering runner' in runner_register.stdout"
      failed_when: false

- name: Display GitLab configuration status
  debug:
    msg: |
      GitLab Configuration Complete
      =============================
      URL: {{ gitlab_url }}
      Health: {{ 'OK' if gitlab_health.status == 200 else 'Check required' }}

      Credentials saved to: {{ gitlab_credentials_file }}

      Manual steps required:
      1. Login with root credentials
      2. Change root password
      3. Configure SMTP settings (Admin -> Settings -> Email)
      4. Set up OIDC with Authentik (Admin -> Settings -> Sign-in restrictions)
      5. Configure Container Registry
      6. Create initial project groups

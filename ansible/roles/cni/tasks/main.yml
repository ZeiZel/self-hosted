---
# CNI role main tasks
# Verifies and configures Calico CNI plugin

- name: Check if Calico is installed
  command: kubectl get daemonset -n kube-system calico-node
  register: calico_check
  changed_when: false
  failed_when: false
  tags: [cni, verify]

- name: Verify Calico installation
  assert:
    that:
      - calico_check.rc == 0
    fail_msg: "Calico CNI is not installed. Run kubespray deployment first."
    success_msg: "Calico CNI is installed"
  tags: [cni, verify]

- name: Get Calico node pods status
  command: kubectl get pods -n kube-system -l k8s-app=calico-node -o wide
  register: calico_pods
  changed_when: false
  tags: [cni, verify]

- name: Display Calico pods status
  debug:
    msg: "{{ calico_pods.stdout_lines }}"
  tags: [cni, verify]

- name: Wait for all Calico node pods to be ready
  command: >
    kubectl wait --for=condition=Ready
    pods -n kube-system -l k8s-app=calico-node
    --timeout={{ verify_timeout }}s
  register: calico_ready
  changed_when: false
  tags: [cni, verify]

- name: Get Calico controller pods status
  command: kubectl get pods -n kube-system -l k8s-app=calico-kube-controllers
  register: calico_controller
  changed_when: false
  tags: [cni, verify]

- name: Display Calico controller status
  debug:
    msg: "{{ calico_controller.stdout_lines }}"
  tags: [cni, verify]

- name: Check current IPPool configuration
  command: kubectl get ippool -o yaml
  register: current_ippool
  changed_when: false
  failed_when: false
  tags: [cni, config]

- name: Display current IPPool
  debug:
    msg: "{{ current_ippool.stdout_lines }}"
  when: current_ippool.rc == 0
  tags: [cni, config]

- name: Create custom IPPool configuration
  copy:
    content: |
      apiVersion: projectcalico.org/v3
      kind: IPPool
      metadata:
        name: {{ calico_ippool_name }}
      spec:
        cidr: {{ calico_ippool_cidr }}
        ipipMode: {{ calico_ippool_ipip_mode }}
        vxlanMode: {{ calico_ippool_vxlan_mode }}
        natOutgoing: {{ calico_ippool_nat_outgoing }}
        disabled: {{ calico_ippool_disabled }}
        nodeSelector: all()
        blockSize: {{ calico_ippool_blocksize }}
    dest: /tmp/calico-ippool.yaml
    mode: '0644'
  tags: [cni, config]

- name: Apply custom IPPool configuration
  command: kubectl apply -f /tmp/calico-ippool.yaml
  register: ippool_apply
  changed_when: "'configured' in ippool_apply.stdout or 'created' in ippool_apply.stdout"
  tags: [cni, config]

- name: Remove temporary IPPool file
  file:
    path: /tmp/calico-ippool.yaml
    state: absent
  tags: [cni, config]

- name: Check Calico BGP node status
  command: kubectl exec -n kube-system -c calico-node calico-node-{{ ansible_hostname }} -- calicoctl node status
  register: calico_node_status
  changed_when: false
  failed_when: false
  tags: [cni, verify, bgp]

- name: Display Calico node status
  debug:
    msg: "{{ calico_node_status.stdout_lines }}"
  when: calico_node_status.rc == 0
  tags: [cni, verify, bgp]

- name: Test pod-to-pod connectivity
  block:
    - name: Create test pod in default namespace
      command: >
        kubectl run cni-test-pod-1
        --image=busybox:1.28
        --restart=Never
        --command -- sleep 3600
      register: test_pod1
      changed_when: "'created' in test_pod1.stdout"
      failed_when: false

    - name: Wait for test pod 1 to be ready
      command: >
        kubectl wait --for=condition=Ready
        pod/cni-test-pod-1
        --timeout=60s
      changed_when: false
      when: test_pod1.rc == 0

    - name: Create test pod in kube-system namespace
      command: >
        kubectl run cni-test-pod-2
        --image=busybox:1.28
        --restart=Never
        --namespace=kube-system
        --command -- sleep 3600
      register: test_pod2
      changed_when: "'created' in test_pod2.stdout"
      failed_when: false

    - name: Wait for test pod 2 to be ready
      command: >
        kubectl wait --for=condition=Ready
        pod/cni-test-pod-2
        --namespace=kube-system
        --timeout=60s
      changed_when: false
      when: test_pod2.rc == 0

    - name: Get test pod 2 IP
      command: >
        kubectl get pod cni-test-pod-2
        -n kube-system
        -o jsonpath='{.status.podIP}'
      register: test_pod2_ip
      changed_when: false
      when: test_pod2.rc == 0

    - name: Test connectivity from pod 1 to pod 2
      command: >
        kubectl exec cni-test-pod-1 -- ping -c 3 {{ test_pod2_ip.stdout }}
      register: ping_result
      changed_when: false
      failed_when: false
      when: test_pod2_ip.stdout is defined

    - name: Display connectivity test result
      debug:
        msg: "Pod-to-pod connectivity: {{ ping_result.rc == 0 | ternary('SUCCESS', 'FAILED') }}"
      when: ping_result.rc is defined

    - name: Cleanup test pod 1
      command: kubectl delete pod cni-test-pod-1 --ignore-not-found
      changed_when: false

    - name: Cleanup test pod 2
      command: kubectl delete pod cni-test-pod-2 -n kube-system --ignore-not-found
      changed_when: false
  tags: [cni, verify, connectivity]

- name: Get Calico network policy count
  command: kubectl get networkpolicies -A --no-headers
  register: netpol_count
  changed_when: false
  tags: [cni, verify, policy]

- name: Display network policy count
  debug:
    msg: "Network policies configured: {{ netpol_count.stdout_lines | length }}"
  tags: [cni, verify, policy]

- name: CNI configuration summary
  debug:
    msg:
      - "========================================="
      - "Calico CNI Configuration Complete"
      - "========================================="
      - "✓ Calico pods: Running"
      - "✓ Controller: Running"
      - "✓ IPPool: {{ calico_ippool_cidr }}"
      - "✓ Encapsulation: {{ calico_ippool_ipip_mode }}"
      - "✓ NAT Outgoing: {{ calico_ippool_nat_outgoing }}"
      - "✓ Network policies: {{ netpol_count.stdout_lines | length }}"
      - "========================================="
  tags: [cni]

# Proxmox Terraform Workspace

This directory contains auto-generated Terraform configuration files for provisioning VMs on Proxmox VE.

## Important

**DO NOT manually edit files in this directory!**

All `.tf` files in this directory are automatically generated by the `proxmox_terraform` Ansible role from templates located in `roles/proxmox_terraform/templates/`.

## Files Generated

When you run the Ansible playbook with the `terraform` tag, these files will be created:

- `main.tf` - Provider configuration (Proxmox connection)
- `variables.tf` - Variable definitions
- `vm_master.tf` - Master node VM resource
- `vm_worker_db.tf` - Database worker VM resource
- `vm_worker_services.tf` - Services worker VM resource
- `vm_worker_apps.tf` - Apps worker VM resource
- `outputs.tf` - Output definitions (VM IPs and IDs)

## State Files

Terraform state files (`terraform.tfstate`, `terraform.tfstate.backup`) are stored here and contain:
- VM IDs
- IP addresses
- Resource states

**These files are gitignored** but should be backed up if you need to preserve infrastructure state.

## Usage

### Provisioning VMs

```bash
# Run via Ansible (recommended)
cd /Users/zeizel/projects/self-hosted/ansible
ansible-playbook -i inventory/hosts.ini all.yml --tags terraform,provision --vault-password-file ~/.ansible_vault_password
```

### Manual Terraform Operations

If you need to run Terraform commands directly:

```bash
cd /Users/zeizel/projects/self-hosted/ansible/terraform/proxmox

# View plan
terraform plan

# Apply changes
terraform apply

# Show outputs (VM IPs)
terraform output

# Destroy VMs (careful!)
terraform destroy
```

## Cleanup

To destroy all VMs and clean up:

```bash
cd /Users/zeizel/projects/self-hosted/ansible/terraform/proxmox
terraform destroy
```

Then remove the VMs from `inventory/hosts.ini` manually.

## Troubleshooting

### "Error: Invalid provider configuration"

Make sure the Proxmox API credentials are correctly set in `group_vars/all/vault.yml`.

### "Error: Error cloning VM"

Check that:
1. The cloud-init template exists (run with `--tags proxmox-setup`)
2. The template ID matches the one in `proxmox_cloud_init_template_id`
3. Storage pool has enough space

### "Error: Resource already exists"

If VMs already exist with the same names/IDs:
1. Import them: `terraform import proxmox_virtual_environment_vm.k8s_master 100`
2. Or delete them manually and retry

## Regenerating Configuration

To regenerate the Terraform files from templates:

```bash
cd /Users/zeizel/projects/self-hosted/ansible
ansible-playbook -i inventory/hosts.ini all.yml --tags terraform --skip-tags provision
```

This will regenerate the `.tf` files without applying changes.
